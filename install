#!/bin/bash
# Copyright (c) 2025 CIYAM Developers
#
# Distributed under the MIT/X11 software license, please refer to the file license.txt
# in the root project directory or http://www.opensource.org/licenses/mit-license.php.

CONFIG_PATH=/etc/ciyam
INSTALL_PATH=/opt/ciyam
SYSTEM_LOG_PATH=/var/log/ciyam

create_fs_file( )
{
 if [ "$1" = "" ]; then
  echo "Error: Unexpected missing name for 'create_fs_file'."
  exit
 fi

 if [ ! -f /home/$CIYAM_USER/$1.img ]; then
  pushd /home/$CIYAM_USER > /dev/null

  sudo fallocate -l 10M $1.img > /dev/null
  sudo mkfs.ext4 $1.img > /dev/null

  if [ ! -d $1 ]; then
   sudo mkdir $1
   sudo mount $1.img $1

   sudo mkdir $1/.ciyam
   sudo mkdir $1/.system
   sudo mv $1/lost+found $1/.system

   sudo chown -R $CIYAM_USER:$HTTPD_GROUP $1

   sudo umount $1
  fi

  popd > /dev/null
 fi
}

copy_config_default( )
{
 if [ "$1" = "" ]; then
  echo "Error: Unexpected missing file name for 'copy_config_default'."
  exit
 fi

 if [ ! -f $CONFIG_PATH/$1.default ]; then
  cp ciyam/$1.default $CONFIG_PATH
  chown $CIYAM_USER:$CIYAM_GROUP $CONFIG_PATH/$1.default

  cp $CONFIG_PATH/$1.default $CONFIG_PATH/$1
  chown $CIYAM_USER:$CIYAM_GROUP $CONFIG_PATH/$1
 else
  cmp -s ciyam/$1.default $CONFIG_PATH/$1.default

  if [ $? -eq 1 ]; then
   echo "Warning: The following changes for '$1.default' might need to be made to '$1'."
   diff ciyam/$1.default $CONFIG_PATH/$1.default
  fi

  cp ciyam/$1.default $CONFIG_PATH
 fi

 if [ ! -L $INSTALL_PATH/$1 ]; then
  ln -s $CONFIG_PATH/$1 $INSTALL_PATH/$1
  chown -h $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH/$1
 fi
}

CIYAM_USER=$USER
CIYAM_GROUP=$(id -gn)

name=$1

is_dev_env=

if [ -d src ]; then
 is_dev_env=1

 # NOTE: If no name was provided then
 # will use 'src/.app_name' (changing
 # to lower case) if exists.
 if [ "$name" = "" ]; then
  if [ -f src/.app_name ]; then
   name=$(<src/.app_name)
   name=${name,,}
  fi
 fi
fi

if [ "$name" = "" ]; then
 name="*"
fi

is_git_env=

if [ -d .git ]; then
 is_git_env=1
fi

if [ "$WEBDIR" = "" ]; then
 if [ -d /var/www/html ]; then
  WEBDIR=/var/www/html
 elif [ -d /srv/www/htdocs ]; then
  WEBDIR=/srv/www/htdocs
 fi
fi

if [ "$WEBDIR" = "" ]; then
 echo "Error: Unable to determine WEBDIR (apache2 not installed?)."

 exit
fi

HTTPD_USER=$(stat -c "%U" $WEBDIR 2> /dev/null)
HTTPD_GROUP=$(stat -c "%G" $WEBDIR 2> /dev/null)

if [ "$HTTPD_GROUP" = "" ]; then
 echo "Error: Unable to determine HTTPD_GROUP (incorrect WEBDIR?)."

 exit
fi

if [ -f /usr/bin/mysql ]; then
 MYSQL=mysql
fi

if [ -f /usr/bin/mariadb ]; then
 MYSQL=mariadb
fi

if [ "$MYSQL" = "" ]; then
 echo "Error: Neither MySQL (nor MariaDB) program was found (not installed?)."

 exit
fi

if [ "$CIYAM_USER" = "root" ]; then
 if [ "$is_dev_env" = "1" ]; then
  echo "Error: Do not run this script as 'root' in a development environment."

  exit
 else
  if [ ! $(getent group ciyam) ]; then
   groupadd ciyam
  fi

  if ! id -u admin > /dev/null 2>&1; then
   useradd -m admin
  fi

  usermod -aG sudo,ciyam,$HTTPD_GROUP admin

  usermod -g $HTTPD_GROUP admin

  echo "admin ALL=(ALL) NOPASSWD:ALL" | (EDITOR="tee -a" visudo)

  chmod g+w $WEBDIR
  chown $HTTPD_USER:$HTTPD_GROUP $WEBDIR

  CIYAM_USER=admin
  CIYAM_GROUP=ciyam
 fi
fi

if [ ! -d /home/$CIYAM_USER ]; then
 echo "Error: Home directory for '$CIYAM_USER' was not found."

 exit
fi

had_error=

release_dir=
release_file=

ls -1 ciyam_$name.*.tar.gz > ~install 2>/dev/null

if [ -s ~install ]; then
 num_files=$(wc -l < ~install)

 if [ "$num_files" != "1" ]; then
  had_error=1

  if [ ! "$name" = "*" ]; then
   echo "Error: Multiple 'ciyam_$name.<ver>.<rev>.tar.gz' files found (move old versions)."
  else
   echo "Error: Multiple 'ciyam_$name.<ver>.<rev>.tar.gz' files found (try ./install 'name')."
  fi
 else
  release_file=$(<~install)
  release_dir=${release_file%.tar.gz}

  if [ ! -d $release_dir ]; then
   tar -xvzf $release_file --exclude='install'
  fi
 fi
else
 had_error=1

 echo "Error: No 'ciyam_$name.<ver>.<rev>.tar.gz' file was found (archive file removed?)."
fi

rm -f ~install

if [ "$had_error" = "1" ]; then
 exit
fi

if [ "$release_dir" = "" ]; then
 echo "Error: Unexpected missing 'release_dir' variable."

 exit
fi

# NOTE: If is a development environment then will save and erase the current
# identity (and also stop the application server if it's currently running).
if [ "$is_dev_env" = "1" ]; then
 pushd src > /dev/null

 if [ -f ciyam_server.sid ]; then
  ./save_identity > /dev/null
  ./erase_identity > /dev/null

  # NOTE: Check if the application server is running.
  touch ciyam_server.cmd
  sleep 1

  if [ -f ciyam_server.cmd ]; then
   rm ciyam_server.cmd
  else
   touch ciyam_server.stop
   sleep 1
  fi
 fi

 popd > /dev/null
else
 create_fs_file backup
 create_fs_file opened
 create_fs_file shared
fi

cd $release_dir

if [ ! -d $CONFIG_PATH ]; then
 sudo mkdir $CONFIG_PATH
 sudo chown $CIYAM_USER:$CIYAM_GROUP $CONFIG_PATH
fi

if [ ! -d $CONFIG_PATH ]; then
 echo "Error: Unable to access/create $CONFIG_PATH directory (incorrect user?)."

 exit
fi

if [ ! -d $INSTALL_PATH ]; then
 sudo mkdir $INSTALL_PATH
 sudo chown $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH
fi

if [ ! -d $INSTALL_PATH ]; then
 echo "Error: Unable to access/create $INSTALL_PATH directory (incorrect user?)."

 exit
fi

if [ ! -d $SYSTEM_LOG_PATH ]; then
 sudo mkdir $SYSTEM_LOG_PATH
 sudo chown $CIYAM_USER:$CIYAM_GROUP $SYSTEM_LOG_PATH

 touch $SYSTEM_LOG_PATH/ciyam_script.log
 sudo chown $CIYAM_USER:$CIYAM_GROUP $SYSTEM_LOG_PATH/ciyam_script.log

 touch $SYSTEM_LOG_PATH/ciyam_server.log
 sudo chown $CIYAM_USER:$CIYAM_GROUP $SYSTEM_LOG_PATH/ciyam_server.log
fi

if [ ! -L $INSTALL_PATH/ciyam_script.log ]; then
 ln -s $SYSTEM_LOG_PATH/ciyam_script.log $INSTALL_PATH/ciyam_script.log
 sudo chown -h $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH/ciyam_script.log
fi

if [ ! -L $INSTALL_PATH/ciyam_server.log ]; then
 ln -s $SYSTEM_LOG_PATH/ciyam_server.log $INSTALL_PATH/ciyam_server.log
 sudo chown -h $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH/ciyam_server.log
fi

service_path=/etc/systemd/system

# NOTE: If not installing as a tarball then should instead use
# use the following directory (which can be achieved by having
# package installations "touch" this file before this script).
if [ -f /usr/lib/systemd/system/ciyam.service ]; then
 service_path=/usr/lib/systemd/system
fi

has_service=

if [ -s $service_path/ciyam.service ]; then
 has_service=1

 sudo systemctl is-active apache2 >/dev/null

 if [ $? -eq 0 ]; then
  sudo systemctl restart apache2
 fi

 sudo systemctl is-active ciyam >/dev/null

 if [ $? -eq 0 ]; then
  sudo systemctl stop ciyam
 fi

 for i in {1..20}
 do
  sudo systemctl is-active ciyam >/dev/null

  if [ $? -ne 0 ]; then
   break;
  fi

  sleep 0.5
 done

 sudo systemctl is-active ciyam >/dev/null

 if [ $? -eq 0 ]; then
  echo "Error: Unable to stop the CIYAM service."

  exit
 fi
fi

is_new=

if [ ! -f $CONFIG_PATH/autoscript.sio ]; then
 is_new=1
fi

copy_config_default autoscript.sio

# NOTE: If is new and is not a development environment
# then uncomment out all default "autoscript" entries.
if [ "$is_new" = "1" ]; then
 if [ "$is_dev_env" = "" ]; then
  sed -i '/<sio\/>/,/<\/sio>/{s/^# / /g}' $CONFIG_PATH/autoscript.sio
 fi
fi

copy_config_default manuscript.sio

copy_config_default ciyam_server.sio

source ./env_vars.sh

rm env_vars.sh

has_system=

# NOTE: Remove the module DB export directory when not new
# and protect the OS user's password from being changed if
# new when is a development environment.
if [ -f $INSTALL_PATH/$CIYAM_APP_MOD.modules.lst ]; then
 has_system=1
 rm -rf ciyam/$CIYAM_APP_MOD
 rm -f ciyam/$CIYAM_APP_MOD.log.app
 rm -f ciyam/$CIYAM_APP_MOD.backup.sql
else
 if [ "$is_dev_env" = "1" ]; then
  touch $INSTALL_PATH/.${CIYAM_USER}_password_protected
 fi
fi

sudo cp -R ciyam/* $INSTALL_PATH
sudo chown -R $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH

if [ "$has_system" = "" ]; then
 if [ "$CIYAM_APP_MOD" = "Meta" ]; then
  # NOTE: Replace the exported "id" with a newly generated "<identity>".
  dbus-uuidgen | xargs -I{} echo -n {} > $INSTALL_PATH/$CIYAM_APP_MOD/id

  echo -n "[0]" > $INSTALL_PATH/$CIYAM_APP_MOD.log
  cat $INSTALL_PATH/$CIYAM_APP_MOD/id >> $INSTALL_PATH/$CIYAM_APP_MOD.log

 else
  # NOTE: Replace the exported "id" with a newly generated "@<identity>".
  dbus-uuidgen | xargs -I{} echo -n @{} > $INSTALL_PATH/$CIYAM_APP_MOD/id

  cat $INSTALL_PATH/$CIYAM_APP_MOD/id | sed 's/@/[0]/g' | xargs echo -e > $INSTALL_PATH/$CIYAM_APP_MOD.log
 fi

 cat $INSTALL_PATH/$CIYAM_APP_MOD.log.app >> $INSTALL_PATH/$CIYAM_APP_MOD.log

 sudo chown $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH/$CIYAM_APP_MOD.log

 rm -f $INSTALL_PATH/$CIYAM_APP_MOD.log.app

 if [ "$is_dev_env" = "1" ]; then
  sed -i "s/# <protocol_handler>file:/ <protocol_handler>apt:/g" $CONFIG_PATH/ciyam_server.sio
 elif [ "$is_git_env" = "1" ]; then
  sed -i "s/# <protocol_handler>file:\/\// <protocol_handler>sftp:\/\/@user@localhost:2222/g" $CONFIG_PATH/ciyam_server.sio
 fi

 sed -i "s/# <default_storage>Meta/ <default_storage>$CIYAM_APP_MOD/g" $CONFIG_PATH/ciyam_server.sio
fi

if [ -f $INSTALL_PATH/manuscript.sio.generated ]; then
 sed -n '/^# Copyright/,/^### .<start generated/p' $CONFIG_PATH/manuscript.sio > $CONFIG_PATH/manuscript.sio.new
 cat $INSTALL_PATH/manuscript.sio.generated >> $CONFIG_PATH/manuscript.sio.new
 cp $CONFIG_PATH/manuscript.sio $CONFIG_PATH/manuscript.sio.old
 $INSTALL_PATH/update $CONFIG_PATH/manuscript.sio $CONFIG_PATH/manuscript.sio.new > /dev/null
fi

needs_restore=

# NOTE: If there is a <main>.map and now <main>.map.new
# then the DB will need to be restored (due to required
# transformations) unless the files are identical.
if [ -f $INSTALL_PATH/$CIYAM_APP_MOD.map ]; then
 if [ -f $INSTALL_PATH/$CIYAM_APP_MOD.map.new ]; then
  cmp -s $INSTALL_PATH/$CIYAM_APP_MOD.map $INSTALL_PATH/$CIYAM_APP_MOD.map.new
  if [ $? -eq 0 ]; then
   rm -f $INSTALL_PATH/$CIYAM_APP_MOD.map.new
  else
   needs_restore=1
  fi
 fi
else
 if [ -f $INSTALL_PATH/$CIYAM_APP_MOD.map.new ]; then
  mv $INSTALL_PATH/$CIYAM_APP_MOD.map.new $INSTALL_PATH/$CIYAM_APP_MOD.map
 fi
fi

# NOTE: Prevent actual Linux users
# from being added for development
# environments.
if [ "$has_system" = "" ]; then
 if [ "$is_dev_env" = "1" ]; then
  touch $INSTALL_PATH/.no_add_user
 fi
fi

sudo chown -R $CIYAM_USER:$CIYAM_GROUP $INSTALL_PATH

rm -r ciyam

if [ ! -d $WEBDIR/$CIYAM_APP_DIR ]; then
 sudo mkdir $WEBDIR/$CIYAM_APP_DIR
 sudo chmod g+w $WEBDIR/$CIYAM_APP_DIR
 sudo chown $CIYAM_USER:$HTTPD_GROUP $WEBDIR/$CIYAM_APP_DIR
fi

if [ ! -d $WEBDIR/$CIYAM_APP_DIR ]; then
 echo "Error: Unable to access/create $WEBDIR/$CIYAM_APP_DIR directory (incorrect perms?)."

 exit
fi

sudo cp -R $CIYAM_APP_DIR/* $WEBDIR/$CIYAM_APP_DIR

sudo chmod -R g+w $WEBDIR/$CIYAM_APP_DIR
sudo chown -R $CIYAM_USER:$HTTPD_GROUP $WEBDIR/$CIYAM_APP_DIR

rm -r $CIYAM_APP_DIR

if [ ! -f $WEBDIR/$CIYAM_APP_DIR/ciyam.pem ]; then
 ln -s /opt/ciyam/ciyam.pem $WEBDIR/$CIYAM_APP_DIR/ciyam.pem
fi

sudo systemctl restart apache2

if [ -f $INSTALL_PATH/$CIYAM_APP_MOD.backup.sql ]; then
 pushd $INSTALL_PATH > /dev/null
 ./create_db $CIYAM_APP_MOD .
 rm -f $CIYAM_APP_MOD.backup.sql
 popd > /dev/null
fi

if [ "$is_dev_env" = "" ]; then
 $INSTALL_PATH/xrep @$INSTALL_PATH/ciyam_sftp.sh.xrep user=$CIYAM_USER > /home/$CIYAM_USER/ciyam_sftp.sh

 sudo chmod a+x /home/$CIYAM_USER/ciyam_sftp.sh
fi

$INSTALL_PATH/xrep @$INSTALL_PATH/ciyam.service.xrep user=$CIYAM_USER group=$CIYAM_GROUP mysql=$MYSQL webdir=$WEBDIR >ciyam.service

sudo mv ciyam.service $service_path

sudo systemctl daemon-reload

if [ "$has_service" = "" ]; then
 sudo systemctl enable ciyam
fi

sudo systemctl start ciyam
sudo systemctl --no-pager status ciyam

cd ..

rmdir $release_dir
