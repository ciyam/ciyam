Linux Lubuntu Specific Instructions
===================================

https://cdimage.ubuntu.com/lubuntu/releases/24.04/release/
(download the .ISO image to use with VirtualBox as the boot install CD/DVD)

Create a New machine in VirtualBox with 4096 MB of memory and create a virtual disk
that is at least 510 GB in size. After create from General set the Shared Clipboard
to bidirectional and in System remove Floppy from the Boot Order.

NOTE: Select Settings -> Storage -> SATA Controller to set "Use Host I/O Cache" on.
(is off by default and will make an enormous difference to DB File I/O performance)

From the Customize menu select a Normal Installation (in order to approx. UTC select
the "Atlantic/Reykjavik" timezone along with the Locale setting as "en_SG.UTF-8").

Create the user "admin" when installing (for demo purposes password to be "linux").

Install Guest Additions (if bidirectional clipboard is not working)
-------------------------------------------------------------------

sudo apt install virtualbox-guest-x11

sudo reboot

Use sudo without a password
---------------------------

sudo visudo
(add the following line at the bottom of the file)
admin ALL=(ALL) NOPASSWD:ALL

If you had selected "Allow Login Without Password" to later prevent that:
sudo vi /etc/sddm.conf
(comment out the AutoLogin lines)

(to disable "smart indenting" in vim)
sudo mv /usr/share/vim/vim91/indent.vim /usr/share/vim/vim91/indent.vim.sav

(and to ensure that auto-commenting doesn't occur in vim either)
echo "set fo-=ro" >>.vimrc

Update to latest version (should reboot immediately after this):

sudo apt update

sudo reboot

To prevent unattended upgrades and stop annoying notifications
--------------------------------------------------------------

sudo systemctl disable --now unattended-upgrades

Preferences -> LXQt Settings -> Session Settings : Auto Start
 (unselect the "Lubuntu Update Autostart" option)
 (and "Geoclue Demo agent" if this is not wanted)

Preferences -> LXQt Settings -> Desktop Notifications
 (check Do Not Disturb)

Install all required packages for CIYAM Software Manufacturing
--------------------------------------------------------------

sudo apt-get install make
sudo apt-get install build-essential

sudo apt install git
sudo apt install procmail
(only needed for "lockfile" and when prompted select No Configuration)

sudo apt install libpng-dev
sudo apt install libhpdf-dev

sudo apt install apache2 libapache2-mod-fcgid
sudo apt install mariadb-server libmariadb-dev

sudo apt-get install libreadline-dev
sudo apt-get install libmysqlclient-dev

Next install and start/restart required services
------------------------------------------------

sudo apt install openssh-server

sudo systemctl enable sshd
sudo systemctl enable mysql
sudo systemctl enable apache2

https://ciyam.org/docs/fcgi_configuration.html

sudo systemctl restart mysql
sudo systemctl restart apache2

sudo vi /etc/ssh/sshd_config
(uncomment out the following line)
PasswordAuthentication yes

sudo systemctl start ssh

sudo systemctl enable ufw

sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow 12021

sudo ufw allow 13031
(if using syncthing)

git clone https://github.com/ciyam/fcgi.git

cd fcgi
./configure
make
sudo make install
sudo cp libfcgi/.libs/libfcgi.so /usr/lib64
sudo ln -s /usr/lib64/libfcgi.so /usr/lib64/libfcgi.so.0
sudo ln -s /usr/lib64/libfcgi.so /usr/lib64/libfcgi.so.0.0.0
cd ..

Export CIYAM environment variables now and for future sesisons
--------------------------------------------------------------
export WEBDIR=/var/www/html
echo 'export WEBDIR=/var/www/html' >> .bashrc
echo 'export WEBDIR=/var/www/html' >> .profile

export MYSQL_EXEC="sudo mariadb"
echo 'export MYSQL_EXEC="sudo mariadb"' >> .bashrc
echo 'export MYSQL_EXEC="sudo mariadb"' >> .profile

export CIYAM_USER=admin
echo 'export CIYAM_USER=admin' >> .bashrc
echo 'export CIYAM_USER=admin' >> .profile

Change default group to "www-data" then add the "users" group
-------------------------------------------------------------
sudo usermod -g www-data admin
newgrp - www-data
sudo usermod -a -G users admin

(to confirm logout and back in then type "groups" and touch a new file)

sudo chmod a+rx /home/admin

sudo chmod g+w $WEBDIR
sudo chown www-data:www-data $WEBDIR

(if initially created may want to remove the following folders)
rmdir Documents
rmdir Downloads
rmdir Music
rmdir Pictures
rmdir Public
rmdir Videos
rmdir Templates

Create backup staging area ext4 file system and automount entry
---------------------------------------------------------------
sudo fallocate -l 10M backup.img
sudo mkfs.ext4 backup.img

sudo vi /etc/fstab
(append the following line)
/home/admin/backup.img  /home/admin/backup ext4 loop 0 0

sudo mkdir backup
sudo mount backup.img backup
(ignore hint about modified fstab)
sudo chown -R admin:www-data backup

sudo umount backup

Create opened staging area ext4 file system and automount entry
---------------------------------------------------------------
sudo fallocate -l 10M opened.img
sudo mkfs.ext4 opened.img

sudo vi /etc/fstab
(append the following line)
/home/admin/opened.img  /home/admin/opened ext4 loop 0 0

sudo mkdir opened
sudo mount opened.img opened
(ignore hint about modified fstab)
sudo chown -R admin:users opened
sudo chmod g+rx /home/admin/opened

sudo umount opened

Create shared staging area ext4 file system and automount entry
---------------------------------------------------------------
sudo fallocate -l 10M shared.img
sudo mkfs.ext4 shared.img

sudo vi /etc/fstab
(append the following line)
/home/admin/shared.img  /home/admin/shared ext4 loop 0 0

sudo mkdir shared
sudo mount shared.img shared
(ignore hint about modified fstab)
sudo chown -R admin:www-data shared

sudo umount shared

Clone the CIYAM Software Manufacturing repository
-------------------------------------------------

git clone https://github.com/ciyam/ciyam

sudo cp ciyam/backup_readme.md /home/admin/backup/README.md
sudo cp ciyam/opened_readme.md /home/admin/opened/README.md
sudo cp ciyam/shared_readme.md /home/admin/shared/README.md

cd ciyam/src

Next follow these instructions up to running the "./erase_identity" script:

***** https://github.com/ciyam/ciyam/blob/master/getting_started.txt  *****

NOTE: If having issues with 'ciyam_server' tests then can try the following:
(if using VirtualBox first check SATA Controller "Use Host I/O Cache" is on)
[ciyam_server.sio]
...
 <ods_use_sync_write>false
...
[ciyam_server.sio]
NOTE: The above setting means that crashes can result in corrupted ODS DB files.

rm ciyam.dat ciyam.hdr ciyam.idx ciyam.log ciyam.sql ciyam.tlg ciyam.modules.lst

NOTE: If having permission issues with 'root'@'localhost' for MySQL try the following:

sudo mysql -u root
SET PASSWORD FOR 'root'@'localhost' = '';
exit
sudo systemctl restart mysql

Installing the CIYAM "systemd" Service
--------------------------------------

NOTE: Do this *only after* the CIYAM application server has been built and the
Meta DB has been created.

vi autoscript.sio
(uncomment out the various "check" scripts)

(if no ciyamd.service exists then ./init_service)
sudo cp ciyamd.service /etc/systemd/system

sudo vi /etc/systemd/system/ciyamd.service
(ensure that the "Environment" value matches the WEBDIR export value above)

Make necessary changes (for VMs) to the "ciyam_server.sio" configuration file:
[ciyam_server.sio]
...
 <protocol_handler>sftp://@user@localhost:2222
 <ods_use_sync_write>false
...
 <default_storage>Home
...
[ciyam_server.sio]

sudo systemctl daemon-reload
sudo systemctl enable ciyamd

sudo systemctl start ciyamd
sudo systemctl status ciyamd

Adding extra package types to Meta
----------------------------------

[packages.lst]
...
Blog
...
Message
...
[packages.lst]

./unbundle Blog.package
mv package.info Blog.package.info

./unbundle Message.package
mv package.info Message.package.info

./upgrade_prototype

Adding 'ciyam.test' host (optional)
-----------------------------------

sudo vi /etc/hosts
[/etc/hosts]
...
10.0.2.2    ciyam.test
...
[/etc/hosts]

Port Forwarding to access the VM from its Host
----------------------------------------------
(Network -> Advanced -> Port Forwarding)
CIYAM    TCP   127.0.0.1   12021    10.0.2.15   12021
HTTP     TCP   127.0.0.1   8888     10.0.2.15   80
SSH      TCP   127.0.0.1   2222     10.0.2.15   22
SYNC     TCP   127.0.0.1   13031    10.0.2.15   13031

Installing Syncthing User Service
---------------------------------

sudo apt-get install syncthing

mkdir .config/systemd
mkdir .config/systemd/user
cp /usr/lib/systemd/system/syncthing* ~/.config/systemd/user

vi ~/.config/systemd/user/syncthing@.service
[syncthing@.service]
...
#User=%i
...
WantedBy=default.target
[syncthing@.service]

systemctl --user enable syncthing.service
systemctl --user start syncthing.service
systemctl --user status syncthing.service

Start a tunnel in order to access the Web UI in the host OS:
ssh -L8384:127.0.0.1:8384 -p 2222 admin@localhost

In local browser: localhost:8384
* Settings/Connections
Sync Protocol Listen Addresses
tcp://:13031

systemctl --user restart syncthing.service
systemctl --user status syncthing.service
