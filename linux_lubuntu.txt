Linux Lubuntu Specific Instructions
===================================

https://cdimage.ubuntu.com/lubuntu/releases/noble/release/
(download the ISO image to use as the VM's install CD/DVD)

Creating VirtualBox Machine
---------------------------

Create a new New machine in VirtualBox typing its Name and then using the ISO Image
Image drop list to select "Other..." then locate the ISO image that was downloaded.
Click on Hardware to select a "Base Memory" size of 4096 MB then click on Hard Disk
and in "Create a Virtual Hard Disk" select a size no less than 510 GB. Click Finish
but before starting up this new VM first click on the Settings button and then from
General -> Advanced select the Shared Clipboard as bidirectional and then in System
remove Floppy from the Boot Order. Lastly in Storage -> Devices -> Controller: SATA
check the "Use Host I/O Cache" option (for a huge difference to DB performance).

Port Forwarding to access the VM from its Host
----------------------------------------------
(Network -> Advanced -> Port Forwarding)
CIYAM    TCP   127.0.0.1   12021    10.0.2.15   12021
HTTP     TCP   127.0.0.1   8888     10.0.2.15   80
SSH      TCP   127.0.0.1   2222     10.0.2.15   22

It should be noted the "localhost" port numbers (other than CIYAM) have been set to
values that are different to the standard ones and can be changed if they are being
used already (although examples below are assuming the values chosen above).

Starting OS Installation
------------------------

Click the green arrow Start in VirutalBox and then hit enter (or just wait a while)
at the initial text menu and then click the "Install Lubuntu" button in the GUI.

The language selection should next be performed and then the Region and Locale need
to be chosen (if wanting to approximate "UTC" then select "Atlantic/Reykjavik" then
depending upon date and number formatting one of "en_SG.UTF-8" or "en_US.UTF-8").

Create the user "admin" when installing (with an initial password as just "linux").

After the Restart select System Tools -> QTerminal to perform all remaining steps.

Install Guest Additions
-----------------------
NOTE: Unfortunately this first "apt install" needs to be manually typed in order to
provide the bidirectional clipboard (which should function after rebooting the VM).

sudo apt install virtualbox-guest-x11 -y

sudo reboot

Use sudo without a password
---------------------------

chsh
(use this to select a preferred shell)

sudo update-alternatives --config editor
(use this to select the default editor)

sudo visudo
(add the following line at the bottom of the file)
admin ALL=(ALL) NOPASSWD:ALL

If you had selected "Allow Login Without Password" to later prevent that:
sudo vi /etc/sddm.conf
(comment out the AutoLogin lines)

(to disable "smart indenting" in vim)
sudo mv /usr/share/vim/vim91/indent.vim /usr/share/vim/vim91/indent.vim.sav

(and to ensure that auto-commenting doesn't occur in vim either)
echo "set fo-=ro" >>.vimrc

Update to latest version (should reboot immediately after this):

sudo apt update

sudo reboot

Support pasting of multiple lines where each line is a command
--------------------------------------------------------------

bind 'set enable-bracketed-paste off'

To prevent unattended upgrades and stop annoying notifications
--------------------------------------------------------------

sudo systemctl disable --now unattended-upgrades

Preferences -> LXQt Settings -> Desktop Notifications
(check Do Not Disturb)

Preferences -> LXQt Settings -> Session Settings : Auto Start
(unselect the "Lubuntu Update Autostart" option)

Install all required packages for CIYAM Software Manufacturing
--------------------------------------------------------------

sudo apt install git -y
(this should already be installed)

sudo apt install qrencode -y
(this is likely to already be installed)

sudo apt install libpng-dev -y
sudo apt install libhpdf-dev -y

sudo apt-get install make -y
sudo apt-get install build-essential -y

sudo apt install apache2 libapache2-mod-fcgid -y
sudo apt install mariadb-server libmariadb-dev -y

sudo apt-get install libreadline-dev -y
sudo apt-get install libmysqlclient-dev -y

Next install and start/restart required services and extras
-----------------------------------------------------------

sudo apt install xclip -y
sudo apt install openssh-server -y

sudo apt autoremove

sudo systemctl enable ssh
sudo systemctl enable mysql
sudo systemctl enable apache2

Apache2 configuration for FCGI support
--------------------------------------

sudo vi /etc/apache2/apache2.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
#ServerRoot "/etc/apache2"
*** add the following line after the above line  ***
ServerName localhost
...
<Directory /var/www/>
   Options Indexes FollowSymLinks
*** change the above line and add the second line ***
   Options ExecCGI FollowSymLinks
   AddHandler fcgid-script .fcgi
...
   AllowOverride None
*** change the above line to become the following ***
   AllowOverride All
...
</Directory>

*** add all of the following lines here ***
<IfModule fcgid_module>
   MaxProcessCount               10
   MaxRequestLen                 100000000
   IdleTimeOut                   3600
   IPCConnectTimeout             20
   IPCCommTimeout                300
   DefaultMaxClassProcessCount   1
   DefaultMinClassProcessCount   1
</IfModule>
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl start mysql
sudo systemctl restart apache2

sudo vi /etc/ssh/sshd_config
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
*** uncomment out the following line ***
PasswordAuthentication yes
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl start ssh

sudo systemctl enable ufw

sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw allow 12021

git clone https://github.com/ciyam/fcgi.git

cd fcgi
./configure
make
sudo make install
sudo cp libfcgi/.libs/libfcgi.so /usr/lib64
sudo ln -s /usr/lib64/libfcgi.so /usr/lib64/libfcgi.so.0
sudo ln -s /usr/lib64/libfcgi.so /usr/lib64/libfcgi.so.0.0.0
cd ..

Export CIYAM environment variables now and for future sesisons
--------------------------------------------------------------
export WEBDIR=/var/www/html
echo "export WEBDIR=$WEBDIR" >> .bashrc

export CIYAM_USER=admin
echo "export CIYAM_USER=$CIYAM_USER" >> .bashrc

export CIYAM_GROUP=www-data
echo "export CIYAM_GROUP=$CIYAM_GROUP" >> .bashrc

export CIYAM_MYSQL="sudo mariadb"
echo "export CIYAM_MYSQL=\"$CIYAM_MYSQL\"" >> .bashrc

Change default group to "www-data" and add the "ciyam" group
------------------------------------------------------------
sudo usermod -g www-data admin
newgrp - www-data

sudo groupadd ciyam
sudo usermod -a -G ciyam admin

Confirm groups by logging out and back in then and type the following:
groups

sudo chmod a+rx /home/admin

sudo chmod g+w $WEBDIR
sudo chown www-data:www-data $WEBDIR

(if initially created may want to remove the following folders)
rmdir Documents
rmdir Downloads
rmdir Music
rmdir Pictures
rmdir Public
rmdir Videos
rmdir Templates

Clone the CIYAM Software Manufacturing repository
-------------------------------------------------

git clone https://github.com/ciyam/ciyam

sudo cp ciyam/backup_readme.md /home/admin/backup/README.md
sudo cp ciyam/opened_readme.md /home/admin/opened/README.md
sudo cp ciyam/shared_readme.md /home/admin/shared/README.md

cd ciyam/src

To compile all targets and run all basic regression tests:

./config

./xrep @sshd_config_app.xrep user=$USER
(append output of this to the following)
sudo vi /etc/ssh/sshd_config

./xrep @ciyam_sftp.sh.xrep user=$USER > /home/$USER/ciyam_sftp.sh
chmod a+x /home/$USER/ciyam_sftp.sh

sudo systemctl restart ssh

make all

./dotests

To ensure that the Meta application will operate correctly:

./create_db ciyam .
./init Meta ciyam
./test -t=../tests Meta_tests.sio
./drop_db ciyam .

./create_db Meta .
./init Meta Meta

./install_test_fcgi

From the host OS use a browser with the following URL:

http://localhost:8888/test_fcgi.html

After clicking on the "Perform Post Request" button the following should be output:

Posted Data: name=Joe+Bloggs&age=&sex=male&submit=Perform+Post+Request...

If you go "back" to the page and then click on the button again you should now see:

Found HTTP_COOKIE: TEST=TEST_COOKIE

Posted Data: name=Joe+Bloggs&age=&sex=male&submit=Perform+Post+Request...

Assuming this has worked next execute the following to install the CIYAM IDE:

./setup Meta meta
./install_fcgi ciyam_interface meta
./install_fcgi upload meta
./install Meta meta index

rm ciyam.dat ciyam.hdr ciyam.idx ciyam.log ciyam.sql ciyam.tlg ciyam.modules.lst

Installing the CIYAM "systemd" Service
--------------------------------------

NOTE: Do this *only after* the CIYAM application server has been built and the
Meta DB has been created.

vi autoscript.sio
(uncomment out all standard scripts)

(if no ciyam.service exists then ./init_service)
sudo cp ciyam.service /etc/systemd/system

sudo vi /etc/systemd/system/ciyam.service
(ensure that the "Environment" values matches the exported values above)

Make necessary changes (for VMs) to the "ciyam_server.sio" configuration file:

vi ciyam_server.sio
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
 <default_storage>Home
...
 <protocol_handler>sftp://@user@localhost:2222
 <ods_use_sync_write>false
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl daemon-reload
sudo systemctl enable ciyam

sudo systemctl start ciyam
sudo systemctl status ciyam

Adding extra package types to Meta
----------------------------------

vi packages.lst
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
Blog
Forum
...
Message
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

./unbundle Blog.package
mv package.info Blog.package.info

./unbundle Forum.package
mv package.info Forum.package.info

./unbundle Message.package
mv package.info Message.package.info

./reconstruct_meta okay

./save_identity
./erase_identity

Adding 'ciyam.test' host (optional)
-----------------------------------

sudo vi /etc/hosts
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
10.0.2.2   ciyam.test
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

******************************** FOR NON-VM MACHINES ******************************

Required router port mappings:
(also need an IP address reservation)

Port #  Label     Local Port Protocol
------  -------   ---------- --------
    80  HTTP            80        TCP
   443  HTTPS          443        TCP
  3477  TURN CTL      3477    TCP/UDP
  3478  LVKT CTL      3478    TCP/UDP
  5348  TURN SCTL     5348    TCP/UDP
  5349  LVKT SCTL     5349    TCP/UDP
  7881  LVKT SRTC     7881        TCP
 10001  SSH          10001        TCP
 12021  CIYAM        12021    TCP/UDP
 13031  SYNC         13031    TCP/UDP
 40000               40000
-44999  LVKT RTC    -44999        UDP
 45000               45000
-49999  LVKT TURN   -49999        UDP
 50000               50000
-59999  TURN DATA   -59999        UDP

Check laptop battery status:

sudo upower -i $(upower -e | grep 'BAT')

For improved laptop battery preservation:

sudo vi /sys/class/power_supply/BAT0/charge_control_start_threshold
(reduce from 95 to 75)

sudo vi /sys/class/power_supply/BAT0/charge_control_end_threshold
(reduce from 100 to 85)

In order to prevent a laptop from sleeping or hibernating:

sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
sudo systemctl status sleep.target suspend.target hibernate.target hybrid-sleep.target

(determine the current external IP address)
hostname -i
***external_ip_address***

(determine the current internal IP address which needs to be static)
hostname -I | cut -d' ' -f1
***internal_ip_address***

With the following assuming that ***domain_name*** is "example.com" then
***domain_prefix*** would be "example" and ***domain_suffix*** is "com".
(while ***other_domain_name*** is being used as a sample virtual domain)

sudo hostnamectl set-hostname ***domain_name*** --static

Installing Syncthing User Service
---------------------------------

sudo apt-get install syncthing

sudo systemctl enable syncthing@admin

sudo systemctl start syncthing@admin
sudo systemctl status syncthing@admin

In the host OS start a tunnel to access the Syncthing UI:
ssh -L 9394:127.0.0.1:8384 -p 2222 admin@localhost

Configure Syncthing from host OS using the following URL:
http://localhost:9394

Setting up an automatically renewed Let's Encrypt certificate
-------------------------------------------------------------

sudo apt-get install python3-certbot
sudo apt-get install python3-certbot-apache

sudo certbot --noninteractive --register-unsafely-without-email --agree-tos --apache -d ***domain_name***,www.***domain_name***
NOTE: Also append ",ntfy.***domain_name***" if wanting to use the "ntfy" service for self-hosted notifications.

sudo systemctl daemon-reload
sudo systemctl status certbot
sudo systemctl list-timers --all

NOTE: Create the following for the CIYAM service to also use certbot certificates.

sudo vi /etc/letsencrypt/renewal-hooks/deploy/ciyam-certbot-deploy.sh
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

set -e

for domain in $RENEWED_DOMAINS; do
 case $domain in
 ***domain_name***)
  daemon_cert_root=/home/admin/ciyam/src

  umask 077

  cat "$RENEWED_LINEAGE/privkey.pem" "$RENEWED_LINEAGE/fullchain.pem" > "$daemon_cert_root/ciyam.pem"

  chown admin "$daemon_cert_root/ciyam.pem"
  chmod 400 "$daemon_cert_root/ciyam.pem"

  systemctl restart ciyam >/dev/null
  ;;
 esac
done
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo chmod 700 /etc/letsencrypt/renewal-hooks/deploy/ciyam-certbot-deploy.sh

NOTE: If wanting to test this deploy hook execute the following:

sudo certbot renew --dry-run --run-deploy-hooks

Installing and configuring Matrix-Synapse with PostgreSQL
---------------------------------------------------------

sudo apt install -y lsb-release wget apt-transport-https
sudo wget -O /usr/share/keyrings/matrix-org-archive-keyring.gpg https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/matrix-org-archive-keyring.gpg] https://packages.matrix.org/debian/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/matrix-org.list

sudo apt install matrix-synapse-py3 -y
sudo apt install postgresql -y

NOTE: Will need to type in a password twice when creating the "synapse_user".

The following is a simple way to create a random 32 character length password:

head -c 32 /dev/random | sha256sum | cut -c -32
***synapse_password***

sudo -u postgres bash
createuser --pwprompt synapse_user
createdb --encoding=UTF8 --locale=C --template=template0 --owner=synapse_user synapse
exit

sudo vi /etc/matrix-synapse/homeserver.yaml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
database:
  name: psycopg2
  args:
    host: localhost
    user: synapse_user
    password: ***synapse_password***
    database: synapse
    cp_min: 5
    cp_max: 10
    cp_reconnect: true
...
registration_shared_secret: "***synapse_password***"
suppress_key_server_warning: true
retention:
 enabled: true
 default_policy:
  min_lifetime: 1d
  max_lifetime: 3d
media_retention:
  local_media_lifetime: 5d
  remote_media_lifetime: 3d
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /usr/lib/systemd/system/matrix-synapse.service
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
[Unit]
...
Requires=postgresql.service
After=postgresql.service
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl daemon-reload

sudo systemctl restart matrix-synapse
sudo systemctl status matrix-synapse

Configure Reverse Proxy for Apache2 Web Server
----------------------------------------------

sudo vi /etc/apache2/sites-available/000-default-le-ssl.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
<VirtualHost *:443>
...
Include /etc/letsencrypt/options-ssl-apache.conf
...
(add the following)
    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPreserveHost on
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
# NOTE: Uncomment out the following if allowing external adminstration.
#    ProxyPass /_synapse/admin http://127.0.0.1:8008/_synapse/admin nocanon
#    ProxyPassReverse /_synapse/admin http://127.0.0.1:8008/_synapse/admin
    ProxyPass /_synapse/client http://127.0.0.1:8008/_synapse/client nocanon
    ProxyPassReverse /_synapse/client http://127.0.0.1:8008/_synapse/client
...
    <Location "/.well-known/matrix/server">
        Header set Access-Control-Allow-Origin "*"
        Header set Content-Type "application/json"
    </Location>
</VirtualHost>

<VirtualHost *:8448>
    SSLEngine on
    ServerName ***domain_name***

(copy these from above)
SSLCertificateFile /etc/letsencrypt/live/***domain_name***/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/***domain_name***/privkey.pem

    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
</VirtualHost>
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

NOTE: To support server federation use the following:

mkdir -p /var/www/html/.well-known/matrix

vi /var/www/html/.well-known/matrix/server
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
{
    "m.server": "***domain_name***:443"
}
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo a2enmod proxy
sudo a2enmod headers
sudo a2enmod proxy_html
sudo a2enmod proxy_http

sudo apachectl configtest

sudo systemctl restart apache2
sudo systemctl status apache2

curl https://***domain_name***/_matrix/client/versions
curl https://***domain_name***/_matrix/federation/v1/version

Install and configure a TURN server for use with Matrix-Synapse
---------------------------------------------------------------
NOTE: Not reqwuired if only using Element-Call for audio/video.

sudo apt install coturn -y

head -c 32 /dev/random | sha256sum | cut -c -32
***coturn_password***

sudo vi /etc/turnserver.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
#listening-port=3478
listening-port=3477
...
#tls-listening-port=5349
tls-listening-port=5348
...
listening-ip=***internal_ip_address***
...
min-port=50000
max-port=59999
...
external-ip=***external_ip_address***
...
use-auth-secret
...
static-auth-secret=***coturn_password***
...
realm=***domain_name***
...
cert=/etc/coturn/certs/***domain_name***.cert
...
pkey=/etc/coturn/certs/***domain_name***.key
..
no-cli
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo ufw allow 3477
sudo ufw allow 5348
sudo ufw allow 50000:59999/udp

sudo mkdir -p /etc/coturn/certs
sudo chown -R turnserver:turnserver /etc/coturn/
sudo chmod -R 700 /etc/coturn/

sudo vi /etc/letsencrypt/renewal-hooks/deploy/coturn-certbot-deploy.sh
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

set -e

for domain in $RENEWED_DOMAINS; do
 case $domain in
 ***domain_name***)
  daemon_cert_root=/etc/coturn/certs

  # Make sure the certificate and private key files are
  # not world readable (even just for an instant) while
  # they are being copied.
  umask 077

  cp "$RENEWED_LINEAGE/fullchain.pem" "$daemon_cert_root/$domain.cert"
  cp "$RENEWED_LINEAGE/privkey.pem" "$daemon_cert_root/$domain.key"

  # Apply file ownership and permissions for the coturn daemon.
  chown turnserver "$daemon_cert_root/$domain.cert" "$daemon_cert_root/$domain.key"
  chmod 400 "$daemon_cert_root/$domain.cert" "$daemon_cert_root/$domain.key"

  systemctl restart coturn >/dev/null
  ;;
 esac
done
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo chmod 700 /etc/letsencrypt/renewal-hooks/deploy/coturn-certbot-deploy.sh

sudo certbot renew --force-renewal

sudo systemctl restart coturn
sudo systemctl status coturn

NOTE: If the external IP is not static then might want to add an update "cron" bash
script such as the following (or instead call it using 'check-external-ip' which is
documented in the LiveKit section).

vi coturn-external-ip
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

current_external_ip=$1
current_external_ip_config=$(sudo cat /etc/turnserver.conf | grep "^external-ip" | cut -d'=' -f2)

if [ "$current_external_ip" = "" ]; then
 current_external_ip=$(dig +tls @9.9.9.9 +short ***domain_name***)
fi

# NOTE: Only checks not empty and has no spaces (use 'ipcalc-ng' for a precise check).
if [[ "$current_external_ip" != "" ]] &&
 [[ "$current_external_ip" != *" "* ]] &&
 [[ $current_external_ip_config != $current_external_ip ]]; then
 sudo sed -i "/^external-ip=/ c external-ip=$current_external_ip" /etc/turnserver.conf
 sudo systemctl restart coturn
fi
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Reconfigure Matrix-Synapse to be able to use the Coturn server
--------------------------------------------------------------

sudo vi /etc/matrix-synapse/homeserver.yaml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
turn_uris:
  - "turn:***domain_name***:3477?transport=udp"
  - "turn:***domain_name***:3477?transport=tcp"
# Due to issues with LetsEncrypt certs these two may need to be omitted.
#  - "turns:***domain_name***:5348?transport=udp"
#  - "turns:***domain_name***:5348?transport=tcp"
turn_shared_secret: "***coturn_password***"
turn_user_lifetime: "1h"
turn_allow_guests: true
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart matrix-synapse
sudo systemctl status matrix-synapse

Install and configure the Ntfy service for use with Apache2 and Matrix-Synapse
------------------------------------------------------------------------------

sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://archive.heckel.io/apt/pubkey.txt | sudo gpg --dearmor -o /etc/apt/keyrings/archive.heckel.io.gpg
sudo apt install apt-transport-https -y
sudo sh -c "echo 'deb [arch=amd64 signed-by=/etc/apt/keyrings/archive.heckel.io.gpg] https://archive.heckel.io/apt debian main' > /etc/apt/sources.list.d/archive.heckel.io.list"
sudo apt update
sudo apt install ntfy -y

sudo systemctl enable ntfy

sudo vi /etc/ntfy/server.yml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
base-url: "https://ntfy.***domain_name***"
...
listen-http: ":2588"
...
cache-file: "/var/cache/ntfy/cache.db"
cache-duration: "24h"
...
behind-proxy: true
...
attachment-cache-dir: "/var/cache/ntfy/attachments"
...
manager-interval: "1h"
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl start ntfy
sudo systemctl status ntfy

sudo vi /etc/apache2/sites-available/000-default-le-ssl.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
<VirtualHost *:443>
    SSLEngine on
    ServerName ntfy.***domain_name***

    ProxyPass / http://127.0.0.1:2588/ upgrade=websocket
    ProxyPassReverse / http://127.0.0.1:2588/

    SetEnv proxy-nokeepalive 1
    SetEnv proxy-sendchunked 1

    # Higher than the max message size of 4096 bytes
    LimitRequestBody 102400

    SSLCertificateFile /etc/letsencrypt/live/***domain_name***/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/***domain_name***/privkey.pem
</VirtualHost>
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart apache2
sudo systemctl status apache2

curl -d "test..." https://ntfy.***domain_name***/test

curl https://ntfy.***domain_name***/_matrix/push/v1/notify

sudo vi /etc/matrix-synapse/homeserver.yaml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
push:
  enabled: true
  include_content: false
  group_unread_count_by_room: false
ip_range_whitelist:
   - '***internal_ip_address***'
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart matrix-synapse
sudo systemctl status matrix-synapse

Creating new users and admin users for Matrix-Synapse
-----------------------------------------------------

sudo register_new_matrix_user -u ***user_name*** -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008

sudo register_new_matrix_user -u ***admin_name*** -a -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008

Account creation with tokens for Matrix-Synapse using Matrix Registration Bot
-----------------------------------------------------------------------------

sudo apt install pipx -y

mkdir matrix-registration

(if not worried about verifying the "bot user" then skip)

******************************* BOT USER VERIFICATION *****************************
pipx install matrix-commander

mv .local/bin/matrix-commander matrix-registration
***********************************************************************************

pipx install matrix-registration-bot

mv .local/bin/matrix-registration-bot matrix-registration

cd matrix-registration

head -c 32 /dev/random | sha256sum | cut -c -32
***registration_password***

sudo register_new_matrix_user -u registration-bot -a -c /etc/matrix-synapse/homeserver.yaml http://localhost:8008
(use the random password just created above)

******************************* BOT USER VERIFICATION *****************************

https://app.element.io

After logging in add a person (to create an initial room) and when prompted to "Set
up recovery" click on Continue then on the "Set up recovery" button (in black) then
Continue again (remembering to keep a copy of the recovery key).

Next verify the "registration-bot" user with Emoji's in the normal manner.

Copy the room identity (needed for matrix-commander) by navigating the following:
Room Info -> Settings -> Advanced.
***room_identity***
(remain logged in to the Web UI whilst proceeding with the following console commands)

./matrix-commander --login password --homeserver https://***domain_name*** --room-default ***room_identity***
(when prompted provide the ***registration_password*** and for the device name use "matrix-registration-bot")

./matrix-commander --verify

Back in the Web UI go to "All Settings -> Sessions" and find the Unverified Session
("matrix-registration-bot") click on it and then click on the Verify Session button
for it (in black).

(the emojis should be displayed in the console - type in "Yes" after confirming the
emojis match those from the Web UI)

cat credentials.json

(copy the access token value from the "cat" output)
***access_token***
******************************* SKIPPING VERIFICATION *****************************

(if either did not install or was unable to login using matrix-commander)

curl -X POST --header 'Content-Type: application/json' -d '{ "identifier": { "type": "m.id.user", "user": "registration-bot" },
 "password": "***registration_password***", "type": "m.login.password"}' 'https://***domain_name***/_matrix/client/r0/login'

(copy the access token value that is shown in the login output)
***access_token***
***********************************************************************************

vi config.yml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
bot:
  server: "https://***domain_name***"
  username: "registration-bot"
#  password: ***registration_password***
  access_token: "***access_token***"
  prefix: ""
api:
  base_url: "https://***domain_name***"
  token: "***access_token***"
logging:
  level: DEBUG/INFO/ERROR
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

(to test interactively)
./matrix-registration-bot

vi matrix-registration-bot.service
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
[Unit]
Description=matrix-registration-bot

[Service]
Type=simple
ExecStart=/home/admin/.local/share/pipx/venvs/matrix-registration-bot/bin/matrix-registration-bot
WorkingDirectory=/home/admin/matrix-registration

Restart=always
RestartSec=30
SyslogIdentifier=matrix-registration-bot

[Install]
WantedBy=multi-user.target
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

****************************** Custom Token Handling ******************************

Because "matrix-registration-bot" outputs the commands it receives (using "cerr") a
"funnel" script can be used pipe the bot output through a "filter" script which can
then execute an arbitrary command. From matrix clients (such as Element) the "show"
command is expected to provide a "token" name which can be tested for in the filter
script.

NOTE: Any "special token" used in the filter should not itself be used as part of a
file or service name (as the script is being run as "root" by default). This custom
token handling implemention should be used in conjunction with "allowed" bot users.
In order to output which "special tokens" are available it is recommended to create
dummy tokens via the following simple "curl" command (which uses ***access_token***
which is the same as used previously):

curl -X POST -H "Content-Type: application/json" -d '{ "token": "echo-test", "uses_allowed": 0 }
' https://***domain_name***/_synapse/admin/v1/registration_tokens/new?access_token=***access_token***

vi matrix-registration-bot-filter
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

while read line
do
 if [[ "$line" == *"'echo-test'"* ]]; then
  echo "This is a test"
 fi
 echo "$line"
done < "${1:-/dev/stdin}"
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

chmod a+x matrix-registration-bot-filter

vi matrix-registration-bot-funnel
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

/home/admin/.local/share/pipx/venvs/matrix-registration-bot/bin/matrix-registration-bot 2>&1 | /home/admin/matrix-registration/matrix-registration-bot-filter

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

chmod a+x matrix-registration-bot-funnel

vi matrix-registration-bot.service
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
ExecStart=/home/admin/matrix-registration/matrix-registration-bot-funnel
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

(to test interactively)
./matrix-registration-bot-funnel

***********************************************************************************

sudo cp matrix-registration-bot.service /usr/lib/systemd/system

sudo systemctl daemon-reload
sudo systemctl start matrix-registration-bot
sudo systemctl status matrix-registration-bot

sudo systemctl enable matrix-registration-bot

You should be able to now add "@registration-bot:***domain_name***" and type "help"
in the chat in order to get instructions on how to use the bot.

sudo vi /etc/matrix-synapse/homeserver.yaml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
suppress_key_server_warning: true
...
enable_registration: true
registration_requires_token: true
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart matrix-synapse
sudo systemctl status matrix-synapse

New users will now be able to create their own account names and passwords provided
that they include a valid registration token.

NOTE: Only the "registration-bot" user itself (via its list of Unverified Sessions)
will work with "matrix-commander --verify" so in order to support verification with
other users need to use the Web UI to login as "registration-bot" with the Recovery
Key Restore being performed. After the restore can do an emoji verification between
users.

NOTE: If not installing the Matrix Authentication Service then new accounts are not
able to be created using Element-X so as a work-around the CIYAM FCGI UI provides a
form to register an account so that you can then manually login with Element-X (and
generate the account recovery key). A URL for this form is as follows:

https://***domain_name***/home?cmd=register&hostname=***domain_name***&token_id=XXX
(where XXX needs to be replaced by an actual token created by the registration bot)

Matrix-Synapse Administration
-----------------------------

The following project is useful for Matrix-Synapse administration.

https://github.com/Awesome-Technologies/synapse-admin

(assuming synapse-admin-VER.REV.tar.gz is in admin's home directory)

cd $WEBDIR
tar -xvzf ~/synapse-admin-VER.REV.tar.gz

rm ~/synapse-admin-VER.REV.tar.gz

mv synapse-admin-VER.REV synapse-admin

vi synapse-admin/config.json
{
 "restrictBaseUrl": "https://***domain_name***"
}

sudo vi /etc/apache2/sites-available/000-default-le-ssl.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
# NOTE: Uncomment out the following if allowing external adminstration.
    ProxyPass /_synapse/admin http://127.0.0.1:8008/_synapse/admin nocanon
    ProxyPassReverse /_synapse/admin http://127.0.0.1:8008/_synapse/admin
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart apache2

https://***domain-name***/synapse-admin

Install and configure LiveKit service (for Element-Call usage with Matrix-Synapse)
----------------------------------------------------------------------------------

sudo curl -sSL https://get.livekit.io | bash
sudo curl -sSL https://get.livekit.io/cli | bash

head -c 32 /dev/random | sha256sum | cut -c -32
***livekit_secret***

sudo vi /etc/livekit.yaml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
port: 7880
bind_addresses:
  - "0.0.0.0"
rtc:
  tcp_port: 7881
  port_range_start: 40000
  port_range_end: 44999
  use_external_ip: true
# NOTE: If livekit-sfu has issues with the external IP address can use this instead:
#  use_external_ip: false
#  node_ip: ***external_ip_address***
logging:
  level: info
turn:
  enabled: true
  udp_port: 3478
  tls_port: 5349
  relay_range_start: 45000
  relay_range_end: 49999
  domain: ***domain_name***
  key_file: /etc/letsencrypt/live/***domain_name***/privkey.pem
  cert_file: /etc/letsencrypt/live/***domain_name***/fullchain.pem
keys:
  devkey: "***livekit_secret***"
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

(to verify if the configuration is valid)
livekit-server --config /etc/livekit.yaml

ufw allow 7881/tcp
ufw allow 3478
ufw allow 5349
ufw allow 40000:49999/udp

vi livekit-sfu.service
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
[Unit]
Description=LiveKit SFU Service
After=network.target

[Service]
Restart=always
ExecStart=/usr/local/bin/livekit-server --config /etc/livekit.yaml

[Install]
WantedBy=multi-user.target
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo cp livekit-sfu.service /usr/lib/systemd/system

sudo systemctl daemon-reload
sudo systemctl enable livekit-sfu

sudo systemctl start livekit-sfu
sudo systemctl status livekit-sfu

https://github.com/element-hq/lk-jwt-service

sudo apt install golang-go

wget https://github.com/element-hq/lk-jwt-service/archive/refs/tags/v0.2.3.tar.gz
tar -xvf v0.2.3.tar.gz
mv lk-jwt-service-0.2.3 lk-jwt-service

cd lk-jwt-service
go build -o lk-jwt-service .

(to verify the application is okay)
LIVEKIT_URL="https://=***domain_name***/livekit/sfu" LIVEKIT_JWT_PORT=8070 LIVEKIT_KEY=devkey LIVEKIT_SECRET=***livekit_secret*** ./lk-jwt-service

cp lk-jwt-service /usr/local/bin

cd ..

vi livekit-jwt.service
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
[Unit]
Description=LiveKit JWT Service
After=network.target

[Service]
Restart=always
ExecStart=/usr/local/bin/lk-jwt-service
Environment="LIVEKIT_URL=wss://=***domain_name***/livekit/sfu"
Environment="LIVEKIT_KEY=devkey"
Environment="LIVEKIT_SECRET=***livekit_secret***"
Environment="LIVEKIT_JWT_PORT=8070"

[Install]
WantedBy=multi-user.target
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo cp livekit-jwt.service /usr/lib/systemd/system

sudo systemctl daemon-reload
sudo systemctl enable livekit-jwt

sudo systemctl start livekit-jwt
sudo systemctl status livekit-jwt

sudo vi /etc/apache2/sites-available/000-default-le-ssl.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
<VirtualHost *:443>
...
    RequestHeader setifempty X-Forwarded-Proto https
    ProxyTimeout 120

    <Location "/.well-known/matrix/client">
        Header set Access-Control-Allow-Origin "*"
        Header set Content-Type "application/json"
    </Location>

    <Location "/.well-known/matrix/server">
        Header set Access-Control-Allow-Origin "*"
        Header set Content-Type "application/json"
    </Location>

    <Location "/livekit/jwt">
        ProxyPreserveHost on
        ProxyAddHeaders on
        ProxyPass "http://localhost:8070/"
        ProxyPassReverse "http://localhost:8070/"
    </Location>

    <Location "/sfu/get">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "POST"
        Header set Access-Control-Allow-Headers "Accept, Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token"

        ProxyPreserveHost on
        ProxyAddHeaders on
        ProxyPass "http://localhost:8070/sfu/get"
        ProxyPassReverse "http://localhost:8070/sfu/get"
    </Location>

    <Location "/livekit/sfu">
        ProxyPreserveHost on
        ProxyAddHeaders on

        # WebSocket-specific configuration
        ProxyPass ws://localhost:7880 upgrade=websocket flushpackets=on
        ProxyPassReverse ws://localhost:7880
    </Location>
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

lk token create --api-key devkey --api-secret ***livekit-secret*** --join --room test_room --identity test_user --valid-for 24h
***access_token***

https://livekit.io/connection-test

Livekit URL: wss://***server***/livekit/sfu
Room Token: ***access_token***

https://github.com/element-hq/element-call/blob/livekit/docs/self-hosting.md

NOTE: If the external IP is not static then might want to add an update "cron" bash
such as the following (which will also call 'coturn-external-ip' if it is present).

vi check-external-ip
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

cd /home/admin

saved_external_ip=

if [ -f .external_ip_address ]; then
 saved_external_ip=$(<.external_ip_address)
fi

current_external_ip=$(dig +tls @9.9.9.9 +short ***domain_name***)

not_good=

if [ "$current_external_ip" = "" ]; then
 not_good=1
fi

if [[ "$current_external_ip" = *" "* ]]; then
 not_good=1
fi

if [ "$current_external_ip" = "127.0.0.1" ]; then
 not_good=1
fi

if [ "$not_good" = "" ]; then
 if [ "$saved_external_ip" != "$current_external_ip" ]; then
  echo -n "$current_external_ip" > .external_ip_address

  if [ -f coturn-external-ip ]; then
   ./coturn-external-ip $current_external_ip
  fi

  # NOTE: This is only required if an explicit 'node_ip' has been configured.
  sudo sed -i "/^  node_ip:/ c \  node_ip: $current_external_ip" /etc/livekit.yaml

  sudo systemctl restart livekit-sfu
 fi
fi
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

mkdir -p /var/www/html/.well-known/matrix

sudo vi /var/www/html/.well-known/matrix/client
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
{
    "m.homeserver":
    {
        "base_url": "https://***domain_name***"
    },

    "org.matrix.msc4143.rtc_foci":
    [
        {
            "type": "livekit",
            "livekit_service_url": "https://***domain_name***"
        }
    ]
}
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/matrix-synapse/homeserver.yaml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
experimental_features:
  # MSC3266: Room summary API. Used for knocking over federation,
  msc3266_enabled: true
  # MSC4222: Needed for syncv2 state_after. This allows clients to
  # correctly track the state of the room.
  msc4222_enabled: true
  # MSC4140: Delayed events are required for proper call participation signalling.
  msc4140_enabled: true

# The maximum allowed duration by which sent events can be delayed, as
# per MSC4140.
#
# NOTE: Due to an issue with Element-X calls (resulting in calls being
# terminated after a few seconds or minutes with an "RTCSession Error"
# message) this option currently needs to be kept commented out (issue
# raised as https://github.com/element-hq/element-call/issues/3257).
#max_event_delay_duration: 24h

rc_message:
  # This needs to match at least E2EE key sharing frequency plus a little extra.
  per_second: 0.5
  burst_count: 30

rc_delayed_event_mgmt:
  # This needs to match at least the heart-beat frequency with a bit of headroom.
  per_second: 5
  burst_count: 25
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart matrix-synapse
sudo systemctl status matrix-synapse

Install and configure email services with Postfix and Dovecot
-------------------------------------------------------------

sudo apt install postfix
(select "Internet Site")
(type ***domain_name***)

sudo dpkg-reconfigure postfix
(use defaults but enter "admin" as the alternative to root)

sudo vi /etc/aliases
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
webmaster:        root
postmaster:       root
root:             admin
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo newaliases

sudo postconf -e 'smtpd_sasl_type = dovecot'
sudo postconf -e 'smtpd_sasl_path = private/auth'
sudo postconf -e 'smtpd_sasl_security_options = noanonymous'
sudo postconf -e 'broken_sasl_auth_clients = yes'
sudo postconf -e 'smtpd_sasl_auth_enable = yes'
sudo postconf -e 'smtpd_recipient_restrictions = permit_sasl_authenticated,permit_mynetworks,reject_unauth_destination'

sudo postconf -e 'smtpd_tls_cert_file = /etc/letsencrypt/live/***domain_name***/fullchain.pem'
sudo postconf -e 'smtpd_tls_key_file = /etc/letsencrypt/live/***domain_name***/privkey.pem'

NOTE: If the ***domain_name*** in use contains three parts (e.g. "home.server.net")
then will need to set "mydomain" to "myhostname" to send email to "user@server.net"
(if it's a different host otherwise such addresses are treated as virtual aliases).

sudo vi /etc/postfix/main.cf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
mydomain = ***domain_name***
...
mydestination = $myhostname, $mydomain, localhost.$mydomain, , localhost
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo postconf -e 'virtual_alias_domains = ***other_domain_name***'
sudo postconf -e 'virtual_alias_maps = hash:/etc/postfix/virtual, regexp:/etc/postfix/virtual-regexp'

sudo vi /etc/postfix/virtual
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
root@***other_domain_name*** admin
webmaster@***other_domain_name*** admin
postmaster@***other_domain_name*** admin
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/postfix/virtual-regexp
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
/.+\.mail@***other_domain_prefix***\.***other_domain_suffix***/ admin
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo postmap /etc/postfix/virtual
sudo postmap /etc/postfix/virtual-regexp

sudo postmap -q webmaster@***other_domain_name*** hash:/etc/postfix/virtual
sudo postmap -q test.mail@***other_domain_name*** regexp:/etc/postfix/virtual-regexp

sudo systemctl restart postfix

sudo vi /etc/postfix/master.cf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
smtps      inet  n       -       -       -       -       smtpd
    -o syslog_name=postfix/smtps
    -o smtpd_tls_wrappermode=yes
    -o smtpd_sasl_auth_enable=yes
    -o smtpd_client_restrictions=permit_sasl_authenticated,reject
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo apt install dovecot-common dovecot-imapd dovecot-pop3d -y

sudo vi /etc/dovecot/conf.d/10-auth.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
disable_plaintext_auth = yes
...
auth_username_format = %Ln
...
auth_mechanisms = plain login
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/dovecot/conf.d/10-master.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
  }
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/dovecot/conf.d/10-ssl.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
ssl = required
...
ssl_cert = </etc/letsencrypt/live/***domain_name***/fullchain.pem
ssl_key = </etc/letsencrypt/live//***domain_name***/privkey.pem
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo dovecot -n
(to verify provided settings)

sudo systemctl restart dovecot

sudo doveadm -D auth test admin@localhost
(verify that SASL should function correctly)

sudo ufw allow 25/tcp
sudo ufw allow 465/tcp
sudo ufw allow 993/tcp
sudo ufw allow 995/tcp

(optional further settings for improved security)
sudo postconf -e 'smtpd_helo_required = yes'
sudo postconf -e 'smtpd_helo_restrictions = reject_non_fqdn_helo_hostname,reject_invalid_helo_hostname,reject_unknown_helo_hostname'
sudo postconf -e 'disable_vrfy_command = yes'
sudo postconf -e 'smtpd_delay_reject = yes'

(optional for "mail" support)
sudo apt install mailutils -y

echo "This is a test." | mail -s Test root
(with aliasing "admin" should receive this)

Adding SPF and DMARC (with optional checking for Postfix)
---------------------------------------------------------

If does not exist then first need to create an MX record for DNS:

Type: MX
Host: [.***domain_name***]
Answer: "***domain_name***"

Now add a TXT record for DNS that is used for SPF verification:

Type: TXT
Host: [.***domain_name***]
Answer: "v=spf1 ip4:***external_ip_address*** -all"

To also support DMARC add another TXT record for DNS:

Type: TXT
Host: _dmarc[.***domain_name***]
Answer: "v=DMARC1; p=reject; pct=100; rua=mailto:dmarc-reports@***domain_name***"

and add the following alias:

sudo vi /etc/aliases
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
dmarc-reports:    root
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo newaliases

sudo postfix reload

SPF only requires the above but to perform SPF checks with own postfix server then:

sudo apt install postfix-policyd-spf-python -y

sudo vi /etc/postfix/master.cf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
policyd-spf  unix  -       n       n       -       0       spawn
    user=policyd-spf argv=/usr/bin/policyd-spf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/postfix/main.cf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
policyd-spf_time_limit = 3200

smtpd_recipient_restrictions =
   permit_mynetworks,
   permit_sasl_authenticated,
   reject_unauth_destination,
   check_policy_service unix:private/policyd-spf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

It may take a while for DNS propagation before using these tools to test:

https://dnschecker.org/spf-record-validation.php
https://dnschecker.org/dmarc-record-validation.php

Adding DKIM for Postfix
-----------------------

sudo apt install opendkim opendkim-tools -y

sudo gpasswd -a postfix opendkim

sudo vi /etc/opendkim.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
#LogWhy                 no
LogWhy                  yes
...
OversignHeaders         From

Mode                    sv
SubDomains              no
AutoRestart             yes
AutoRestartRate         10/1M
Background              yes
DNSTimeout              5
SignatureAlgorithm      rsa-sha256
...
#Nameservers            127.0.0.1

# Map domains in From addresses to keys
KeyTable                refile:/etc/opendkim/key.table
SigningTable            refile:/etc/opendkim/signing.table

# Ignore list
ExternalIgnoreList      /etc/opendkim/trusted.hosts

# Internal hosts whose mail should be signed
InternalHosts           /etc/opendkim/trusted.hosts
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo mkdir /etc/opendkim
sudo mkdir /etc/opendkim/keys
sudo chown -R opendkim:opendkim /etc/opendkim
sudo chmod go-rw /etc/opendkim/keys

sudo vi /etc/opendkim/signing.table
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
*@***domain_name***     default._domainkey.***domain_name***
*@*.***domain_name***   default._domainkey.***domain_name***
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/opendkim/key.table
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
default._domainkey.***domain_name***  ***domain_name***:default:/etc/opendkim/keys/***domain_name***/default.private
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo vi /etc/opendkim/trusted.hosts
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
127.0.0.1
::1
localhost
.***domain_name***
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo mkdir /etc/opendkim/keys/***domain_name***
sudo opendkim-genkey -b 2048 -d ***domain_name*** -D /etc/opendkim/keys/***domain_name*** -s default -v

sudo chown opendkim:opendkim /etc/opendkim/keys/***domain_name***/default.private
sudo chmod 600 /etc/opendkim/keys/***domain_name***/default.private

sudo cat /etc/opendkim/keys/***domain_name***/default.txt

Type: TXT
Host: default._domainkey[.***domain_name***]
Answer: "v=DKIM1; k=rsa; p=<first_line><second_line>"

sudo mkdir /var/spool/postfix/opendkim
sudo chown opendkim:postfix /var/spool/postfix/opendkim

sudo vi /etc/opendkim.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
#Socket                 local:/run/opendkim/opendkim.sock
#Socket                 inet:8891@localhost
#Socket                 inet:8891
Socket                  local:/var/spool/postfix/opendkim/opendkim.sock
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo service opendkim restart

sudo vi /etc/postfix/main.cf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
milter_default_action = accept
milter_protocol = 6
smtpd_milters = local:opendkim/opendkim.sock
non_smtpd_milters = $smtpd_milters
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl restart postfix

sudo opendkim-testkey -d ***domain_name*** -s default -vvv
(ignore "key not secure" and check that last line ends with "key OK")

https://dnschecker.org/dkim-record-checker.php

Install and configure Fail2Ban for Postfix SASL
-----------------------------------------------

sudo apt install fail2ban -y

(to prevent WARNING when starting)
sudo vi /etc/fail2ban/fail2ban.conf
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
allowipv6 = auto
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

sudo vi /etc/fail2ban/jail.local
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
bantime = 60m
banfactor = 2
...
findtime = 60m
...
maxretry = 3
...
[sshd]
...
mode     = aggressive
...
[postfix-sasl]
enabled  = true
filter   = postfix[mode=aggressive]
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo systemctl enable fail2ban
sudo systemctl start fail2ban

sudo fail2ban-client status
sudo fail2ban-client status sshd
sudo fail2ban-client status postfix-sasl

Creating a Cron Job for new mail notifications using Ntfy
---------------------------------------------------------

NOTE: The "mail" utility needs to be installed (if skipped previously).
sudo apt install mailutils -y

sudo apt install lockfile-progs -y

sudo wget -O /usr/bin/expand_template https://raw.githubusercontent.com/ciyam/ciyam/master/expand_template
sudo chmod a+x /usr/bin/expand_template

sudo wget -O /usr/bin/check_mail_epoch.sh.template https://raw.githubusercontent.com/ciyam/ciyam/master/check_mail_epoch.sh.template

sudo vi /etc/ntfy/client.yml
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
...
# default-host: https://ntfy.sh
default-host: https://ntfy.***domain_name***
...
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sudo su ***user_name***

cd ~

mkdir -p ~/.config/ntfy
ln -s /etc/ntfy/client.yml ~/.config/ntfy/client.yml

expand_template /usr/bin/check_mail_epoch.sh.template check_mail_epoch.sh

chmod a+x check_mail_epoch.sh

(run manually to check that no error occurs)
./check_mail_epoch.sh

crontab -e
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
* * * * * /home/***user_name***/check_mail_epoch.sh >/dev/null 2>&1
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

NOTE: The "2>&1" stops Cron from automatically emailing when an error occurs during
script execution (such as being unable to lock the user's mailbox to scan headers).

On the mobile device subscribe to the ntfy topic: up_***user_name***

Creating a Cron Job for new Matrix notifications using Ntfy
-----------------------------------------------------------

Although when using "ntfy" on a mobile device it should receive a notification in a
few seconds the Element (or Element-X) application often takes a lot longer to wake
up and report the notification (which is not very helpful for incoming calls). What
follows will provide a secondary notifcation (straight to "ntfy") which can be used
as a work-around to get closer to having "instant" notifications.

NOTE: If these two commands were not performed from the prior section.
sudo wget -O /usr/bin/expand_template https://raw.githubusercontent.com/ciyam/ciyam/master/expand_template
sudo chmod a+x /usr/bin/expand_template

sudo wget -O /usr/bin/check_ntfy_epoch.sh.template https://raw.githubusercontent.com/ciyam/ciyam/master/check_ntfy_epoch.sh.template

sudo su ***user_name***

cd ~

expand_template /usr/bin/check_ntfy_epoch.sh.template check_ntfy_epoch.sh

chmod a+x check_ntfy_epoch.sh

NOTE: The ***topic_name*** needs to be obtained from "ntfy" on the mobile device.

vi check_ntfy.sh
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
#!/bin/bash

while true
do
 ntfy subscribe up***topic_name*** "/home/***user_name***/check_ntfy_epoch.sh Matrix"

 if [ -f /home/***user_name***/check_ntfy.stop ]; then
  rm /home/***user_name***/check_ntfy.stop
  break
 fi

 sleep 10
done
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

chmod a+x check_ntfy.sh

(run manually to check that no error occurs)
./check_ntfy.sh

crontab -e
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
@reboot /home/***user_name***/check_ntfy.sh >/dev/null 2>&1
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

NOTE: Use the following commands in order to force immediate execution.
sudo rm /var/run/crond.reboot
sudo systemctl restart cron

On the mobile device subscribe to the ntfy topic: up_***user_name***

Upgrading to a new version of Lubuntu OS
----------------------------------------

sudo apt update
sudo apt full-upgrade

sudo reboot

sudo do-release-upgrade
