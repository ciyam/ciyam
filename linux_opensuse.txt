Linux OpenSUSE Specific Instructions
====================================

https://get.opensuse.org/tumbleweed
(download the .ISO image to use with VirtualBox as the install CD/DVD)

Create the user "tux" when installing then (firstly for sudo without password):

sudo vi /etc/sudoers
[add the following line]
tux ALL=(ALL) NOPASSWD:ALL

(to disable "smart indenting")
sudo mv /usr/share/vim/current/indent.vim /usr/share/vim/current/indent.vim.sav

(to create "clip" for copying text to the clipboard)
vi bin/clip
if [ $# -lt 1 ]; then
 echo "Usage: clip [\"text\""
else
 echo -n "$1" | xclip -selection clipboard -display "$DISPLAY"
fi

Updgrade to latest version (will have to reboot after):

sudo zypper dup

Change the CD/DVD to Guest Additions then mount, install and reboot:

sudo mount /dev/cdrom /mnt
cd /mnt
sudo ./VBoxLinuxAdditions.run 
sudo reboot

Next install all required packages for CIYAM Software Manufacturing:

sudo zypper install make
sudo zypper install gcc-c++
sudo zypper install git-core
sudo zypper install png++-devel
sudo zypper install libharu-devel
sudo zypper install readline-devel
sudo zypper install mariadb libmariadb-devel
sudo zypper install apache2 apache2-mod_fcgid

Next configure and start required services:

sudo a2enmod fcgid

https://ciyam.org/docs/fcgi_configuration.html

sudo systemctl enable sshd
sudo systemctl enable mysql
sudo systemctl enable apache2

sudo service mysql restart
sudo service apache2 restart

NOTE: Use "yast" to add "http" and "ssh" to the public zone of the firewall.

sudo vi /usr/etc/ssh/sshd_config
[uncomment out the following line]
PasswordAuthentication yes

sudo service sshd restart

git clone https://github.com/ciyam/fcgi.git

cd fcgi
./configure
make
sudo make install
sudo cp libfcgi/.libs/libfcgi.so /usr/lib64
sudo ln -s /usr/lib64/libfcgi.so /usr/lib64/libfcgi.so.0
sudo ln -s /usr/lib64/libfcgi.so /usr/lib64/libfcgi.so.0.0.0
cd ..

Export CIYAM environment variables now and for future sesisons
--------------------------------------------------------------
export WEBDIR=/srv/www/htdocs
echo 'export WEBDIR=/srv/www/htdocs' >> .bashrc
echo 'export WEBDIR=/srv/www/htdocs' >> .profile

export MYSQL_EXEC="sudo mysql"
echo 'export MYSQL_EXEC="sudo mysql"' >> .bashrc
echo 'export MYSQL_EXEC="sudo mysql"' >> .profile

export CIYAM_USER=tux
echo 'export CIYAM_USER=tux' >> .bashrc
echo 'export CIYAM_USER=tux' >> .profile

Add the "vboxsf" and "www" groups for "tux" user and change the default
-----------------------------------------------------------------------
sudo usermod -a -G vboxsf tux
sudo usermod -g vboxsf tux
newgrp - vboxsf
sudo usermod -a -G www tux
sudo usermod -g www tux
newgrp - www

sudo chmod g+w /srv/www/htdocs
sudo chown wwwrun:www /srv/www/htdocs

Create cached files area
------------------------

sudo mkdir cached
cd cached
sudo vi README.md

[README.md]
CIYAM Cached Files Area
=======================

If you are reading this then a backup or restore is now active - please disconnect and try again later.

NOTE: If still seeing this after being disconnected for an hour then this device may require rebooting.
[README.md]

Create backup staging area ext4 file system and automount entry
---------------------------------------------------------------
sudo fallocate -l 10M backup.img
sudo mkfs.ext4 backup.img

sudo vi /etc/fstab
[append the following line]
/home/tux/backup.img  /home/tux/backup ext4 loop 0 0

sudo mkdir backup
cd backup
sudo vi README.md

[README.md]
CIYAM Backup Staging Area
=========================

If you are reading this then a backup or restore is now active - please disconnect and try again later.

NOTE: If still seeing this after being disconnected for an hour then this device may require rebooting.
[README.md]

cd ..

sudo mount backup.img backup
sudo chown -R tux:www backup

sudo umount backup

Create shared staging area ext4 file system and automount entry
---------------------------------------------------------------
sudo fallocate -l 10M shared.img
sudo mkfs.ext4 shared.img

sudo vi /etc/fstab
[append the following line]
/home/tux/shared.img  /home/tux/shared ext4 loop 0 0

sudo mkdir shared
cd shared
sudo vi README.md

[README.md]
CIYAM Shared Staging Area
=========================

If you are reading this then an import or export is now active - please disconnect and try again later.

NOTE: If still seeing this after being disconnected for an hour then this device may require rebooting.
[REAMDE.md]

cd ..

sudo mount shared.img shared
sudo chown -R tux:www shared

sudo umount shared

Clone the CIYAM Software Manufacturing repository
-------------------------------------------------

git clone https://github.com/ciyam/ciyam

sudo cp ciyam/backup_readme.md /home/tux/backup/README.md

cd ciyam/src

Next follow these instructions:

***** https://github.com/ciyam/ciyam/blob/master/getting_started.txt  *****

Installing the CIYAM "systemd" Service
--------------------------------------

NOTE: Do this *only after* the CIYAM application server has been built and the
Meta DB has been created.

vi autoscript.sio

./xrep @ciyamd.service.xrep uid=$USER >ciyamd.service
sudo cp ciyamd.service /etc/systemd/system

sudo vi /etc/systemd/system/ciyamd.service
(ensure that the "Environment" value matches the WEBDIR export value above)

Make necessary changes (for VMs) to the "ciyam_server.sio" configuration file:
...
 <ods_use_sync_write>false
...

sudo systemctl daemon-reload
sudo systemctl enable ciyamd

sudo service ciyamd start
sudo service ciyamd status
